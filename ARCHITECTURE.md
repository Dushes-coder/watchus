# Watch Together — Архитектура проекта

## 🏗️ Общая схема

```
┌─────────────────────────────────────────────────────────────────┐
│                         БРАУЗЕР (Клиент)                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                      index.html                           │ │
│  │  ┌─────────────────────────────────────────────────────┐  │ │
│  │  │  Левая панель (.left-panel)                         │  │ │
│  │  │  ┌───────────────────────────────────────────────┐  │  │ │
│  │  │  │  Видеоплеер (#playerContainer)               │  │  │ │
│  │  │  │  - HTML5 <video>                             │  │  │ │
│  │  │  │  - HLS (hls.js)                              │  │  │ │
│  │  │  │  - YouTube IFrame API                        │  │  │ │
│  │  │  └───────────────────────────────────────────────┘  │  │ │
│  │  │  ┌───────────────────────────────────────────────┐  │  │ │
│  │  │  │  Игры (games-grid)                           │  │  │ │
│  │  │  │  - Шахматы ♟️                                 │  │  │ │
│  │  │  │  - Крестики-нолики ⭕                         │  │  │ │
│  │  │  │  - Карты 🃏                                   │  │  │ │
│  │  │  └───────────────────────────────────────────────┘  │  │ │
│  │  │  ┌───────────────────────────────────────────────┐  │  │ │
│  │  │  │  Активная игра (#activeGamePanel)            │  │  │ │
│  │  │  │  └─ Контейнер (#gameContainer)               │  │  │ │
│  │  │  └───────────────────────────────────────────────┘  │  │ │
│  │  └─────────────────────────────────────────────────────┘  │ │
│  │                                                            │ │
│  │  ┌─────────────────────────────────────────────────────┐  │ │
│  │  │  Правая панель (.right-panel)                       │  │ │
│  │  │  ┌───────────────────────────────────────────────┐  │  │ │
│  │  │  │  Чат (#chatBox)                              │  │  │ │
│  │  │  │  - Список сообщений                          │  │  │ │
│  │  │  │  - Поле ввода (#chatMsg)                     │  │  │ │
│  │  │  └───────────────────────────────────────────────┘  │  │ │
│  │  │  ┌───────────────────────────────────────────────┐  │  │ │
│  │  │  │  Настройки комнаты                           │  │  │ │
│  │  │  │  - Room ID                                   │  │  │ │
│  │  │  │  - Video URL                                 │  │  │ │
│  │  │  └───────────────────────────────────────────────┘  │  │ │
│  │  └─────────────────────────────────────────────────────┘  │ │
│  │                                                            │ │
│  │  ┌─────────────────────────────────────────────────────┐  │ │
│  │  │  Плавающая камера (.floating-cam)                   │  │ │
│  │  │  - Локальное видео (#localVideo)                    │  │ │
│  │  │  - Удалённое видео (#remoteVideo)                   │  │ │
│  │  │  - Кнопки управления (камера, PiP, закрыть)         │  │ │
│  │  └─────────────────────────────────────────────────────┘  │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                      styles.css                           │ │
│  │  - CSS-переменные (цвета, отступы)                       │ │
│  │  - Макет (grid, flex)                                     │ │
│  │  - Компоненты (панели, кнопки, формы)                    │ │
│  │  - Игры (шахматы, крестики-нолики, карты)                │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                      client.js                            │ │
│  │  ┌─────────────────────────────────────────────────────┐  │ │
│  │  │  Socket.IO клиент (window.socket)                   │  │ │
│  │  │  - Подключение к серверу                            │  │ │
│  │  │  - Отправка/получение событий                       │  │ │
│  │  └─────────────────────────────────────────────────────┘  │ │
│  │  ┌─────────────────────────────────────────────────────┐  │ │
│  │  │  Управление плеером                                 │  │ │
│  │  │  - loadPlayer(url)                                  │  │ │
│  │  │  - applyIncomingEvent(type, data)                   │  │ │
│  │  │  - Синхронизация play/pause/seek                    │  │ │
│  │  └─────────────────────────────────────────────────────┘  │ │
│  │  ┌─────────────────────────────────────────────────────┐  │ │
│  │  │  Чат                                                │  │ │
│  │  │  - Отправка сообщений                               │  │ │
│  │  │  - Получение сообщений                              │  │ │
│  │  └─────────────────────────────────────────────────────┘  │ │
│  │  ┌─────────────────────────────────────────────────────┐  │ │
│  │  │  WebRTC (видеосвязь)                                │  │ │
│  │  │  - createPeerConnection()                           │  │ │
│  │  │  - startLocalCamera()                               │  │ │
│  │  │  - Обмен SDP/ICE кандидатами                        │  │ │
│  │  └─────────────────────────────────────────────────────┘  │ │
│  │  ┌─────────────────────────────────────────────────────┐  │ │
│  │  │  Плавающая камера                                   │  │ │
│  │  │  - Drag & Drop                                      │  │ │
│  │  │  - Изменение размера                                │  │ │
│  │  │  - Picture-in-Picture                               │  │ │
│  │  └─────────────────────────────────────────────────────┘  │ │
│  │  ┌─────────────────────────────────────────────────────┐  │ │
│  │  │  Экспорт глобальных переменных                      │  │ │
│  │  │  - window.socket                                    │  │ │
│  │  │  - window.roomId                                    │  │ │
│  │  └─────────────────────────────────────────────────────┘  │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                      games.js                             │ │
│  │  ┌─────────────────────────────────────────────────────┐  │ │
│  │  │  Использует глобальные переменные                   │  │ │
│  │  │  - window.socket (Socket.IO)                        │  │ │
│  │  │  - window.roomId (текущая комната)                  │  │ │
│  │  └─────────────────────────────────────────────────────┘  │ │
│  │  ┌─────────────────────────────────────────────────────┐  │ │
│  │  │  Шахматы                                            │  │ │
│  │  │  - initChess()                                      │  │ │
│  │  │  - renderChessBoard()                               │  │ │
│  │  │  - handleChessCellClick()                           │  │ │
│  │  │  - generateMovesFor()                               │  │ │
│  │  └─────────────────────────────────────────────────────┘  │ │
│  │  ┌─────────────────────────────────────────────────────┐  │ │
│  │  │  Крестики-нолики                                    │  │ │
│  │  │  - initTicTacToe()                                  │  │ │
│  │  │  - renderTicTacToeBoard()                           │  │ │
│  │  │  - handleTicTacToeCellClick()                       │  │ │
│  │  │  - checkTicTacToeWinner()                           │  │ │
│  │  └─────────────────────────────────────────────────────┘  │ │
│  │  ┌─────────────────────────────────────────────────────┐  │ │
│  │  │  Карты (Дурак)                                      │  │ │
│  │  │  - initCards()                                      │  │ │
│  │  │  - renderCardsGame()                                │  │ │
│  │  │  - handleCardClick()                                │  │ │
│  │  │  - shuffleDeck(), dealCards()                       │  │ │
│  │  └─────────────────────────────────────────────────────┘  │ │
│  │  ┌─────────────────────────────────────────────────────┐  │ │
│  │  │  Экспорт функций                                    │  │ │
│  │  │  - window.openGame(game)                            │  │ │
│  │  │  - window.closeGame()                               │  │ │
│  │  │  - window.chessPieces                               │  │ │
│  │  └─────────────────────────────────────────────────────┘  │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                              ▲ │
                              │ │ Socket.IO
                              │ ▼
┌─────────────────────────────────────────────────────────────────┐
│                      СЕРВЕР (Node.js)                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                      server.js                            │ │
│  │  ┌─────────────────────────────────────────────────────┐  │ │
│  │  │  Express                                            │  │ │
│  │  │  - Раздача статических файлов (public/)            │  │ │
│  │  │  - Маршрут GET / → index.html                      │  │ │
│  │  └─────────────────────────────────────────────────────┘  │ │
│  │  ┌─────────────────────────────────────────────────────┐  │ │
│  │  │  Socket.IO сервер                                   │  │ │
│  │  │  - Обработка подключений                            │  │ │
│  │  │  - Управление комнатами (join-room)                 │  │ │
│  │  └─────────────────────────────────────────────────────┘  │ │
│  │  ┌─────────────────────────────────────────────────────┐  │ │
│  │  │  Обработчики событий                                │  │ │
│  │  │  - join-room: присоединение к комнате               │  │ │
│  │  │  - player-event: синхронизация плеера               │  │ │
│  │  │  - load-video: смена видео                          │  │ │
│  │  │  - chat-message: отправка сообщений                 │  │ │
│  │  │  - webrtc-offer/answer/ice: WebRTC сигнализация    │  │ │
│  │  │  - chess-move, game_event: игровые события          │  │ │
│  │  └─────────────────────────────────────────────────────┘  │ │
│  │  ┌─────────────────────────────────────────────────────┐  │ │
│  │  │  Хранилище состояния (in-memory)                    │  │ │
│  │  │  - roomStates: Map<roomId, state>                  │  │ │
│  │  │    - url: текущее видео                             │  │ │
│  │  │    - time: текущее время                            │  │ │
│  │  │    - playing: состояние воспроизведения             │  │ │
│  │  └─────────────────────────────────────────────────────┘  │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔄 Поток данных

### 1. Синхронизация плеера

```
Пользователь A                    Сервер                    Пользователь B
     │                               │                            │
     │  1. Нажимает Play             │                            │
     ├──────────────────────────────►│                            │
     │  player-event                 │                            │
     │  { type: 'play',              │                            │
     │    data: { time: 42 } }       │                            │
     │                               │                            │
     │                               │  2. Ретранслирует          │
     │                               ├───────────────────────────►│
     │                               │  player-event              │
     │                               │  { type: 'play',           │
     │                               │    data: { time: 42 } }    │
     │                               │                            │
     │                               │                            │  3. Применяет
     │                               │                            │     событие
     │                               │                            │     (play + seek)
     │                               │                            │
```

### 2. Чат

```
Пользователь A                    Сервер                    Пользователь B
     │                               │                            │
     │  1. Вводит сообщение          │                            │
     ├──────────────────────────────►│                            │
     │  chat-message                 │                            │
     │  { roomId: 'room1',           │                            │
     │    author: '🐶',              │                            │
     │    message: 'Привет!' }       │                            │
     │                               │                            │
     │                               │  2. Рассылает всем         │
     │◄──────────────────────────────┤───────────────────────────►│
     │  chat-message                 │  chat-message              │
     │  { author: '🐶',              │  { author: '🐶',           │
     │    message: 'Привет!',        │    message: 'Привет!',     │
     │    time: 1234567890 }         │    time: 1234567890 }     │
     │                               │                            │
```

### 3. WebRTC (видеосвязь)

```
Пользователь A                    Сервер                    Пользователь B
     │                               │                            │
     │  1. Включает камеру           │                            │
     │  2. Создаёт offer             │                            │
     ├──────────────────────────────►│                            │
     │  webrtc-offer                 │                            │
     │  { sdp: {...} }               │                            │
     │                               │                            │
     │                               │  3. Пересылает offer       │
     │                               ├───────────────────────────►│
     │                               │  webrtc-offer              │
     │                               │  { from: 'socketA',        │
     │                               │    sdp: {...} }            │
     │                               │                            │
     │                               │                            │  4. Создаёт answer
     │                               │◄───────────────────────────┤
     │                               │  webrtc-answer             │
     │                               │  { sdp: {...} }            │
     │                               │                            │
     │  5. Получает answer           │                            │
     │◄──────────────────────────────┤                            │
     │  webrtc-answer                │                            │
     │  { from: 'socketB',           │                            │
     │    sdp: {...} }               │                            │
     │                               │                            │
     │  6. Обмен ICE кандидатами     │                            │
     │◄─────────────────────────────►│◄──────────────────────────►│
     │  webrtc-ice                   │  webrtc-ice                │
     │                               │                            │
     │  7. Установлено P2P соединение (через STUN)               │
     │◄──────────────────────────────────────────────────────────►│
     │                  Прямая передача видео/аудио               │
     │                                                             │
```

### 4. Игры

```
Пользователь A                    Сервер                    Пользователь B
     │                               │                            │
     │  1. Открывает шахматы         │                            │
     │     (openGame('chess'))       │                            │
     │                               │                            │
     │  2. Делает ход                │                            │
     ├──────────────────────────────►│                            │
     │  chess-move                   │                            │
     │  { from: {row:6, col:4},      │                            │
     │    to: {row:4, col:4},        │                            │
     │    roomId: 'room1' }          │                            │
     │                               │                            │
     │                               │  3. Ретранслирует          │
     │                               ├───────────────────────────►│
     │                               │  chess-move                │
     │                               │  { from: {...},            │
     │                               │    to: {...} }             │
     │                               │                            │
     │                               │                            │  4. Обновляет
     │                               │                            │     доску
     │                               │                            │
```

---

## 📦 Модульная структура

```
┌─────────────────────────────────────────────────────────────┐
│                        client.js                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────────┐  ┌──────────────────┐               │
│  │  Socket.IO       │  │  Video Player    │               │
│  │  - socket        │  │  - loadPlayer    │               │
│  │  - roomId        │  │  - applyEvent    │               │
│  └──────────────────┘  └──────────────────┘               │
│                                                             │
│  ┌──────────────────┐  ┌──────────────────┐               │
│  │  Chat            │  │  WebRTC          │               │
│  │  - sendMsg       │  │  - startCamera   │               │
│  │  - receiveMsg    │  │  - createPC      │               │
│  └──────────────────┘  └──────────────────┘               │
│                                                             │
│  ┌──────────────────┐  ┌──────────────────┐               │
│  │  Floating Cam    │  │  UI Handlers     │               │
│  │  - drag          │  │  - modal         │               │
│  │  - resize        │  │  - buttons       │               │
│  │  - PiP           │  │  - forms         │               │
│  └──────────────────┘  └──────────────────┘               │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Экспорт: window.socket, window.roomId             │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                         games.js                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────────┐  ┌──────────────────┐               │
│  │  Chess           │  │  Tic Tac Toe     │               │
│  │  - initChess     │  │  - initTTT       │               │
│  │  - renderBoard   │  │  - renderBoard   │               │
│  │  - handleClick   │  │  - handleClick   │               │
│  │  - generateMoves │  │  - checkWinner   │               │
│  └──────────────────┘  └──────────────────┘               │
│                                                             │
│  ┌──────────────────┐  ┌──────────────────┐               │
│  │  Cards           │  │  Game Manager    │               │
│  │  - initCards     │  │  - openGame      │               │
│  │  - renderCards   │  │  - closeGame     │               │
│  │  - handleClick   │  │                  │               │
│  │  - shuffleDeck   │  │                  │               │
│  └──────────────────┘  └──────────────────┘               │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Использует: window.socket, window.roomId          │   │
│  │  Экспорт: window.openGame, window.closeGame        │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 🎯 Ключевые точки интеграции

### 1. **Глобальные переменные (window.*)**
Связывают `client.js` и `games.js`:
```javascript
// client.js создаёт:
window.socket = socket;
window.roomId = roomId;

// games.js использует:
window.socket.emit('chess-move', {...});
window.roomId // текущая комната

// games.js экспортирует:
window.openGame = openGame;
window.closeGame = closeGame;
window.chessPieces = {...};
```

### 2. **DOM-элементы**
Связывают HTML и JavaScript:
```html
<!-- index.html -->
<div id="activeGamePanel" class="game-panel hidden">
    <div class="panel-header">
        <span id="activeGameIcon">🎮</span>
        <span id="activeGameTitle">Игра</span>
        <button onclick="closeGame()">✕</button>
    </div>
    <div id="gameContainer"><!-- games.js рендерит сюда --></div>
</div>

<div class="game-card" onclick="openGame('chess')">
    <div class="game-icon">♟️</div>
    <div class="game-title">Шахматы</div>
</div>
```

### 3. **Socket.IO события**
Связывают клиент и сервер:
```javascript
// Клиент → Сервер
socket.emit('player-event', { roomId, type, data });
socket.emit('chat-message', { roomId, author, message });
socket.emit('webrtc-offer', { roomId, sdp });

// Сервер → Клиент
socket.on('player-event', ({ type, data }) => {...});
socket.on('chat-message', ({ author, message, time }) => {...});
socket.on('webrtc-offer', ({ from, sdp }) => {...});
```

### 4. **CSS-классы**
Связывают JavaScript и стили:
```javascript
// games.js генерирует HTML с классами:
html += '<div class="ttt-board">';
html += '<div class="ttt-cell">';
html += '<div class="card hearts">';

// styles.css определяет стили:
.ttt-board { display: grid; grid-template-columns: repeat(3, 80px); }
.ttt-cell { width: 80px; height: 80px; }
.card.hearts { color: #e53935; }
```

---

## 🚀 Жизненный цикл приложения

### 1. **Загрузка страницы**
```
1. Браузер загружает index.html
2. Парсит HTML → создаёт DOM
3. Загружает styles.css → применяет стили
4. Загружает socket.io.js → window.io доступен
5. Загружает hls.js → window.Hls доступен
6. Загружает YouTube API → window.YT доступен (асинхронно)
7. Загружает client.js → выполняется код:
   - Создаётся socket = io()
   - Экспортируется window.socket, window.roomId
   - Регистрируются обработчики событий
8. Загружает games.js → выполняется код:
   - Инициализируется window.chessPieces
   - Экспортируются window.openGame, window.closeGame
9. DOMContentLoaded → инициализация UI
10. Авто-вход (если есть URL-параметры или localStorage)
```

### 2. **Вход в комнату**
```
1. Пользователь вводит roomId и videoUrl
2. Нажимает "Войти"
3. client.js:
   - roomId = rid; updateGlobalRoomId(roomId);
   - socket.emit('join-room', { roomId });
   - socket.emit('load-video', { roomId, url });
   - loadPlayer(url);
4. Сервер:
   - socket.join(roomId);
   - roomStates.set(roomId, { url, time: 0, playing: false });
   - socket.emit('room-state', { state });
   - io.in(roomId).emit('player-event', { type: 'load', data: { url } });
5. Другие клиенты в комнате:
   - Получают player-event
   - Загружают то же видео
   - Синхронизируют время
```

### 3. **Синхронизация плеера**
```
1. Пользователь A нажимает Play
2. client.js (A):
   - video.play();
   - socket.emit('player-event', { roomId, type: 'play', data: { time } });
3. Сервер:
   - roomStates.set(roomId, { ...state, playing: true, time });
   - socket.to(roomId).emit('player-event', { type: 'play', data: { time } });
4. client.js (B):
   - Получает player-event
   - applyIncomingEvent('play', { time });
   - video.currentTime = time; video.play();
```

### 4. **Открытие игры**
```
1. Пользователь кликает на карточку игры
2. HTML: onclick="openGame('chess')"
3. games.js:
   - openGame('chess')
   - Обновляет #activeGameIcon и #activeGameTitle
   - Показывает #activeGamePanel
   - Вызывает initChess()
4. initChess():
   - Инициализирует window.gameState
   - Вызывает renderChessBoard()
5. renderChessBoard():
   - Генерирует HTML с шахматной доской
   - Вставляет в #gameContainer
   - Регистрирует обработчики кликов
```

---

## 📊 Таблица ответственности файлов

| Файл          | Ответственность                                      | Зависимости                    |
|---------------|------------------------------------------------------|--------------------------------|
| `index.html`  | Структура страницы, подключение скриптов/стилей      | -                              |
| `styles.css`  | Визуальное оформление всех компонентов               | -                              |
| `client.js`   | Плеер, чат, WebRTC, камера, UI-обработчики           | Socket.IO, hls.js, YouTube API |
| `games.js`    | Логика игр (шахматы, крестики-нолики, карты)         | `window.socket`, `window.roomId` |
| `server.js`   | HTTP-сервер, Socket.IO, управление комнатами         | Express, Socket.IO             |

---

## ✨ Итог

Архитектура **Watch Together** построена на:
- **Модульности**: каждый файл отвечает за свою область
- **Глобальных переменных**: для связи между модулями
- **Socket.IO**: для real-time коммуникации
- **WebRTC**: для P2P видеосвязи
- **Единообразии**: общие CSS-переменные и классы

Проект легко расширяем и поддерживаем благодаря чёткому разделению ответственности! 🎉
