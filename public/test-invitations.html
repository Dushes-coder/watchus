<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π Watch Together</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
        button { padding: 10px 15px; margin: 5px; }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π</h1>

    <div class="test-section">
        <h3>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É</h3>
        <button onclick="testConnection()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</button>
        <div id="connection-status"></div>
    </div>

    <div class="test-section">
        <h3>2. –í—Ö–æ–¥ –≤ —Ç–µ—Å—Ç–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É</h3>
        <input type="text" id="test-room-id" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã" value="test-invitations">
        <button onclick="joinTestRoom()">–í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</button>
        <div id="join-status"></div>
    </div>

    <div class="test-section">
        <h3>3. –°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ –≤ –∫–æ–º–Ω–∞—Ç–µ</h3>
        <button onclick="getPlayersList()">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
        <div id="players-list"></div>
    </div>

    <div class="test-section">
        <h3>4. –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è</h3>
        <input type="text" id="target-player-id" placeholder="ID –∏–≥—Ä–æ–∫–∞ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è">
        <select id="game-type">
            <option value="tictactoe">–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏</option>
            <option value="chess">–®–∞—Ö–º–∞—Ç—ã</option>
        </select>
        <button onclick="sendTestInvitation()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ</button>
        <div id="invitation-status"></div>
    </div>

    <div class="test-section">
        <h3>5. –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è</h3>
        <div id="received-invitations"></div>
    </div>

    <script src="socket.io/socket.io.js"></script>
    <script>
        let socket;
        let currentRoomId = null;

        function testConnection() {
            const status = document.getElementById('connection-status');
            status.innerHTML = 'üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';

            socket = io('http://localhost:3000');

            socket.on('connect', () => {
                status.innerHTML = '<span class="success">‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É! ID: ' + socket.id + '</span>';
            });

            socket.on('disconnect', () => {
                status.innerHTML = '<span class="error">‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞</span>';
            });

            socket.on('connect_error', (error) => {
                status.innerHTML = '<span class="error">‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message + '</span>';
            });
        }

        function joinTestRoom() {
            if (!socket) {
                alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É!');
                return;
            }

            const roomId = document.getElementById('test-room-id').value.trim();
            if (!roomId) {
                alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã!');
                return;
            }

            const status = document.getElementById('join-status');
            status.innerHTML = 'üîÑ –í—Ö–æ–¥ –≤ –∫–æ–º–Ω–∞—Ç—É...';

            currentRoomId = roomId;
            socket.emit('join-room', { roomId: roomId, userEmoji: 'ü§ñ' });

            socket.on('room-players', (players) => {
                status.innerHTML = '<span class="success">‚úÖ –£—Å–ø–µ—à–Ω–æ –≤–æ—à–ª–∏ –≤ –∫–æ–º–Ω–∞—Ç—É! –ò–≥—Ä–æ–∫–æ–≤: ' + players.length + '</span>';
                updatePlayersList(players);
            });
        }

        function getPlayersList() {
            if (!socket || !currentRoomId) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∫–æ–º–Ω–∞—Ç—É!');
                return;
            }

            socket.emit('get-room-players', { roomId: currentRoomId });
        }

        function updatePlayersList(players) {
            const listDiv = document.getElementById('players-list');
            if (!players || players.length === 0) {
                listDiv.innerHTML = '–ù–µ—Ç –∏–≥—Ä–æ–∫–æ–≤ –≤ –∫–æ–º–Ω–∞—Ç–µ';
                return;
            }

            let html = '<ul>';
            players.forEach(player => {
                const isCurrent = player.id === socket.id;
                html += `<li>${isCurrent ? 'üëë ' : ''}${player.emoji} ${player.name} (ID: ${player.id})</li>`;
            });
            html += '</ul>';
            listDiv.innerHTML = html;
        }

        function sendTestInvitation() {
            if (!socket || !currentRoomId) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∫–æ–º–Ω–∞—Ç—É!');
                return;
            }

            const targetPlayerId = document.getElementById('target-player-id').value.trim();
            const gameType = document.getElementById('game-type').value;

            if (!targetPlayerId) {
                alert('–í–≤–µ–¥–∏—Ç–µ ID –∏–≥—Ä–æ–∫–∞ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è!');
                return;
            }

            const status = document.getElementById('invitation-status');
            status.innerHTML = 'üîÑ –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è...';

            socket.emit('send-game-invitation', {
                roomId: currentRoomId,
                targetPlayerId: targetPlayerId,
                gameType: gameType,
                senderName: 'ü§ñ –¢–µ—Å—Ç–æ–≤—ã–π –∏–≥—Ä–æ–∫'
            });

            status.innerHTML = '<span class="success">‚úÖ –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!</span>';

            // –°–ª—É—à–∞–µ–º –æ—Ç–≤–µ—Ç –Ω–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
            socket.on('game-invitation-response', (data) => {
                if (data.accepted) {
                    status.innerHTML = '<span class="success">‚úÖ –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ! –ò–≥—Ä–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è...</span>';
                } else {
                    status.innerHTML = '<span class="error">‚ùå –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ</span>';
                }
            });
        }

        // –°–ª—É—à–∞–µ–º –≤—Ö–æ–¥—è—â–∏–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
        socket && socket.on('game-invitation', (data) => {
            const invitationsDiv = document.getElementById('received-invitations');
            invitationsDiv.innerHTML = `
                <div style="border: 1px solid #ccc; padding: 10px; margin: 10px 0;">
                    <strong>üì® –ù–æ–≤–æ–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ!</strong><br>
                    –û—Ç: ${data.senderEmoji} ${data.senderName}<br>
                    –ò–≥—Ä–∞: ${data.gameType === 'tictactoe' ? '–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏' : '–®–∞—Ö–º–∞—Ç—ã'}<br>
                    <button onclick="acceptInvitation('${data.gameType}', '${data.senderId}')">‚úÖ –ü—Ä–∏–Ω—è—Ç—å</button>
                    <button onclick="declineInvitation('${data.senderId}')">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                </div>
            ` + invitationsDiv.innerHTML;
        });

        function acceptInvitation(gameType, senderId) {
            socket.emit('game-invitation-response', {
                roomId: currentRoomId,
                senderId: senderId,
                accepted: true,
                gameType: gameType
            });

            document.getElementById('received-invitations').innerHTML = '<span class="success">‚úÖ –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ!</span>';
        }

        function declineInvitation(senderId) {
            socket.emit('game-invitation-response', {
                roomId: currentRoomId,
                senderId: senderId,
                accepted: false
            });

            document.getElementById('received-invitations').innerHTML = '<span class="error">‚ùå –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ</span>';
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            testConnection();
        };
    </script>
</body>
</html>
