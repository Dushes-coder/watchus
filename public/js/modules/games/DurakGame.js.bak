// ===== DURAK GAME CLASS =====

import { BaseGame } from '../core/BaseGame.js';

// –ö–ª–∞—Å—Å –¥–ª—è –∏–≥—Ä—ã –≤ –¥—É—Ä–∞–∫
class DurakGame extends BaseGame {
    constructor() {
        super('durak');
        this.maxHandSize = 6;
        this.trumpSuit = null;
        this.currentAttacker = 'player';
        this.gamePhase = 'attack'; // 'attack', 'defend', 'finished'
        this.winner = null;
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–ª–æ–¥—ã
    createDeck() {
        this.deck = [];
        const suits = ['‚ô†', '‚ô•', '‚ô¶', '‚ô£'];
        const values = ['6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
        suits.forEach(suit => {
            values.forEach(value => {
                this.deck.push({
                    suit,
                    value,
                    power: this.getCardPower(value)
                });
            });
        });
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–∏–ª—ã –∫–∞—Ä—Ç—ã
    getCardPower(value) {
        const powers = { '6': 6, '7': 7, '8': 8, '9': 9, '10': 10, 'J': 11, 'Q': 12, 'K': 13, 'A': 14 };
        return powers[value] || 0;
    }

    // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ –∫–æ–ª–æ–¥—ã
    shuffleDeck() {
        for (let i = this.deck.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [this.deck[i], this.deck[j]] = [this.deck[j], this.deck[i]];
        }
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ CSS-–∫–ª–∞—Å—Å–∞ –¥–ª—è –º–∞—Å—Ç–∏
    getSuitClass(suit) {
        const classes = { '‚ô•': 'hearts', '‚ô¶': 'diamonds', '‚ô£': 'clubs', '‚ô†': 'spades' };
        return classes[suit] || '';
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
    init() {
        try {
            console.log('DurakGame.init() called');
            if (!super.init()) {
                console.log('DurakGame.init(): super.init() failed');
                return false;
            }
            console.log('DurakGame.init(): super.init() success, container found:', !!this.container);

            if (this.isNetworkGame) {
                // –î–ª—è —Å–µ—Ç–µ–≤–æ–π –∏–≥—Ä—ã —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å —Å–µ—Ä–≤–µ—Ä–∞
                console.log('DurakGame.init(): Network game detected');
                this.setupPlayerMapping();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ
                this.showLoadingState();
                
                // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
                if (this.socket && this.roomId) {
                    this.socket.on('game-state', (gameState) => {
                        console.log('DurakGame: Received game state update:', gameState);
                        this.gameState = gameState;
                        this.render();
                    });
                    
                    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
                    this.socket.emit('get-game-state', { roomId: this.roomId });
                }
                
                // –ù–ï –≤—ã–∑—ã–≤–∞–µ–º render() –∑–¥–µ—Å—å - –∂–¥–µ–º gameState —Å —Å–µ—Ä–≤–µ—Ä–∞
                return true;
            }

            // –õ–æ–∫–∞–ª—å–Ω–∞—è –∏–≥—Ä–∞ (—Å –±–æ—Ç–æ–º)
            this.gameState = {
                gameMode: 'durak',
                deck: [],
                playerHand: [],
                opponentHand: [],
                attackingCards: [],
                defendingCards: [],
                trumpSuit: null,
                currentAttacker: 'player',
                gamePhase: 'attack',
                winner: null,
                roundWinner: null
            };

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º mapping –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è —Å–µ—Ç–µ–≤–æ–π –∏–≥—Ä—ã
            this.setupPlayerMapping();

            // –°–æ–∑–¥–∞–µ–º –∫–æ–ª–æ–¥—É, —Ä–∞–∑–¥–∞–µ–º –∫–∞—Ä—Ç—ã, –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–∑—ã—Ä—è –∏ –ø–µ—Ä–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞
            this.createDeck();
            this.shuffleDeck();
            this.setTrumpSuit();
            this.dealInitialCards();
            this.determineFirstPlayer();

            console.log('DurakGame.init(): calling render');
            this.render();
            console.log('DurakGame.init(): render completed');

            return true;
        } catch (error) {
            console.error('DurakGame.init(): Error during initialization:', error);
            return false;
        }
    }
    setupPlayerMapping() {
        if (this.socket && this.roomId && this.currentOpponent?.type === 'player') {
            this.isNetworkGame = true;
            this.gameState.players = [this.socket.id, this.currentOpponent.id];
        }
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤ –∏–≥—Ä–æ–∫–æ–≤ (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å InvitationManager)
    setupPlayerSymbols() {
        this.setupPlayerMapping();
    }

    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–∑—ã—Ä–Ω–æ–π –º–∞—Å—Ç–∏
    setTrumpSuit() {
        if (this.deck.length > 0) {
            this.gameState.trumpSuit = this.deck[this.deck.length - 1].suit;
        }
    }

    // –ù–∞—á–∞–ª—å–Ω–∞—è —Ä–∞–∑–¥–∞—á–∞ –∫–∞—Ä—Ç
    dealInitialCards() {
        this.gameState.playerHand = [];
        this.gameState.opponentHand = [];

        for (let i = 0; i < this.maxHandSize; i++) {
            if (this.deck.length > 0) this.gameState.playerHand.push(this.deck.pop());
            if (this.deck.length > 0) this.gameState.opponentHand.push(this.deck.pop());
        }
    }

    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞ (—Å —Å–∞–º—ã–º –º–ª–∞–¥—à–∏–º –∫–æ–∑—ã—Ä–µ–º)
    determineFirstPlayer() {
        const trumpSuit = this.gameState.trumpSuit;

        // –ù–∞—Ö–æ–¥–∏–º –∫–æ–∑—ã—Ä–∏ —É –∏–≥—Ä–æ–∫–∞
        const playerTrumps = this.gameState.playerHand.filter(card => card.suit === trumpSuit);
        const opponentTrumps = this.gameState.opponentHand.filter(card => card.suit === trumpSuit);

        let playerLowestTrump = null;
        let opponentLowestTrump = null;

        if (playerTrumps.length > 0) {
            playerLowestTrump = playerTrumps.reduce((lowest, card) =>
                card.power < lowest.power ? card : lowest
            );
        }

        if (opponentTrumps.length > 0) {
            opponentLowestTrump = opponentTrumps.reduce((lowest, card) =>
                card.power < lowest.power ? card : lowest
            );
        }

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫—Ç–æ —Ö–æ–¥–∏—Ç –ø–µ—Ä–≤—ã–º
        if (playerLowestTrump && opponentLowestTrump) {
            if (playerLowestTrump.power < opponentLowestTrump.power) {
                this.gameState.currentAttacker = 'player';
            } else {
                this.gameState.currentAttacker = 'opponent';
                // –ï—Å–ª–∏ –±–æ—Ç —Ö–æ–¥–∏—Ç –ø–µ—Ä–≤—ã–º, –¥–µ–ª–∞–µ–º –µ–≥–æ —Ö–æ–¥
                if (this.currentOpponent?.type === 'bot') {
                    setTimeout(() => this.makeBotAttack(), 1000);
                }
            }
        } else if (playerLowestTrump) {
            this.gameState.currentAttacker = 'player';
        } else if (opponentLowestTrump) {
            this.gameState.currentAttacker = 'opponent';
            if (this.currentOpponent?.type === 'bot') {
                setTimeout(() => this.makeBotAttack(), 1000);
            }
        } else {
            // –ù–∏ —É –∫–æ–≥–æ –Ω–µ—Ç –∫–æ–∑—ã—Ä–µ–π - –∏–≥—Ä–æ–∫ —Ö–æ–¥–∏—Ç –ø–µ—Ä–≤—ã–º
            this.gameState.currentAttacker = 'player';
        }
    }

    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∏–≥—Ä—ã
    render() {
        if (!this.gameState) {
            console.log('DurakGame.render(): gameState not loaded yet, showing loading state');
            this.showLoadingState();
            return;
        }

        let html = this.renderOpponentInfo();
        html += '<div class="durak-game">';
        html += '<h3>üé¥ –î—É—Ä–∞–∫</h3>';
        html += '<div class="game-info">';
        html += '<div>–ö–æ–∑—ã—Ä—å: <span class="trump-suit ' + (this.gameState.trumpSuit ? this.getSuitClass(this.gameState.trumpSuit) : '') + '">' + (this.gameState.trumpSuit || '?') + '</span></div>';
        html += '<div>–ö–∞—Ä—Ç –≤ –∫–æ–ª–æ–¥–µ: ' + (this.gameState.deck ? this.gameState.deck.length : 0) + '</div>';
        const phaseName = this.gameState.gamePhase === 'attack' ? '–ê—Ç–∞–∫–∞' : '–ó–∞—â–∏—Ç–∞';
        const attackerName = this.gameState.currentAttacker === this.getCurrentPlayerRole() ? '–í—ã' : '–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫';
        html += '<div>–§–∞–∑–∞: ' + phaseName + ' (' + attackerName + ')</div>';
        html += '</div>';

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–∏–µ —Ä—É–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å
        let playerCards = [];
        let opponentCards = [];
        let playerCardCount = 0;
        let opponentCardCount = 0;

        if (this.isNetworkGame) {
            // –í —Å–µ—Ç–µ–≤–æ–π –∏–≥—Ä–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä—É–∫–∏ –ø–æ —Ä–æ–ª—è–º
            const currentPlayerRole = this.getCurrentPlayerRole();
            if (currentPlayerRole === 'player1') {
                playerCards = this.gameState.player1Hand || [];
                opponentCards = this.gameState.player2Hand || [];
            } else {
                playerCards = this.gameState.player2Hand || [];
                opponentCards = this.gameState.player1Hand || [];
            }
            playerCardCount = playerCards.length;
            opponentCardCount = opponentCards.length;
        } else {
            // –õ–æ–∫–∞–ª—å–Ω–∞—è –∏–≥—Ä–∞ —Å –±–æ—Ç–æ–º
            playerCards = this.gameState.playerHand || [];
            opponentCards = this.gameState.opponentHand || [];
            playerCardCount = playerCards.length;
            opponentCardCount = opponentCards.length;
        }

        // –ö–∞—Ä—Ç—ã –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞
        html += '<div class="opponent-cards">';
        html += '<h4>–ö–∞—Ä—Ç—ã –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ (' + opponentCardCount + '):</h4>';
        html += '<div class="cards-hand opponent-hand">';
        for (let i = 0; i < opponentCardCount; i++) {
            html += '<div class="card card-back">üÇ†</div>';
        }
        html += '</div></div>';

        // –°—Ç–æ–ª —Å –∫–∞—Ä—Ç–∞–º–∏
        html += '<div class="durak-table">';
        html += '<h4>–°—Ç–æ–ª:</h4>';
        html += '<div class="table-cards">';
        for (let i = 0; i < (this.gameState.attackingCards || []).length; i++) {
            const attackCard = this.gameState.attackingCards[i];
            const defendCard = this.gameState.defendingCards[i];

            html += '<div class="card-pair">';
            html += '<div class="card ' + this.getSuitClass(attackCard.suit) + ' attacking">';
            html += '<div class="card-value">' + attackCard.value + '</div>';
            html += '<div class="card-suit">' + attackCard.suit + '</div>';
            html += '</div>';

            if (defendCard) {
                html += '<div class="card ' + this.getSuitClass(defendCard.suit) + ' defending">';
                html += '<div class="card-value">' + defendCard.value + '</div>';
                html += '<div class="card-suit">' + defendCard.suit + '</div>';
                html += '</div>';
            }
            html += '</div>';
        }
        html += '</div></div>';

        // –ö–∞—Ä—Ç—ã –∏–≥—Ä–æ–∫–∞
        html += '<div class="player-cards">';
        html += '<h4>–í–∞—à–∏ –∫–∞—Ä—Ç—ã:</h4>';
        html += '<div class="cards-hand player-hand">';
        playerCards.forEach((card, i) => {
            if (card && card.suit && card.value) {
                const suitClass = this.getSuitClass(card.suit);
                const canPlay = this.canPlayCard(card, i);
                const playableClass = canPlay ? ' playable' : '';
                html += '<div class="card ' + suitClass + playableClass + '" data-index="' + i + '" onclick="window.gameManager.getCurrentGame().handleCardClick(' + i + ')">';
                html += '<div class="card-value">' + card.value + '</div>';
                html += '<div class="card-suit">' + card.suit + '</div>';
                html += '</div>';
            }
        });
        html += '</div></div>';

        // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        html += '<div class="durak-controls">';

        // –ö–Ω–æ–ø–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–∞–∑—ã –∏–≥—Ä—ã
        const currentPlayerRole = this.getCurrentPlayerRole();
        if (this.gameState.gamePhase === 'defend' && this.gameState.currentAttacker !== currentPlayerRole) {
            // –ò–≥—Ä–æ–∫ –∑–∞—â–∏—â–∞–µ—Ç—Å—è
            html += '<button onclick="window.gameManager.getCurrentGame().takeCards()" class="action-btn">–í–∑—è—Ç—å –∫–∞—Ä—Ç—ã</button>';
            html += '<button onclick="window.gameManager.getCurrentGame().passTurn()" class="action-btn">–ü–∞—Å (–≤–∑—è—Ç—å)</button>';
        }

        if (this.gameState.gamePhase === 'attack' && this.gameState.currentAttacker === currentPlayerRole) {
            // –ò–≥—Ä–æ–∫ –∞—Ç–∞–∫—É–µ—Ç
            if ((this.gameState.attackingCards || []).length > 0) {
                html += '<button onclick="window.gameManager.getCurrentGame().passTurn()" class="action-btn">–ü–∞—Å (–∑–∞–≤–µ—Ä—à–∏—Ç—å –∞—Ç–∞–∫—É)</button>';
            }
        }

        if (this.gameState.gamePhase === 'defend' && this.gameState.currentAttacker === currentPlayerRole) {
            // –ò–≥—Ä–æ–∫ –∞—Ç–∞–∫–æ–≤–∞–ª, –º–æ–∂–µ—Ç –ø–æ–¥–∫–∏–Ω—É—Ç—å
            const allDefended = (this.gameState.attackingCards || []).every((_, index) => this.gameState.defendingCards[index]);
            if (allDefended && (this.gameState.attackingCards || []).length > 0) {
                html += '<button onclick="window.gameManager.getCurrentGame().passTurn()" class="action-btn">–ü–∞—Å (–æ—Ç–±–æ–π)</button>';
            }
        }

        if (this.gameState.gamePhase === 'attack' && this.gameState.currentAttacker !== currentPlayerRole) {
            // –ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –∞—Ç–∞–∫–æ–≤–∞–ª, –∏–≥—Ä–æ–∫ –º–æ–∂–µ—Ç –ø–æ–¥–∫–∏–Ω—É—Ç—å –µ—Å–ª–∏ –≤—Å–µ –æ—Ç–±–∏—Ç—ã
            const allDefended = (this.gameState.attackingCards || []).every((_, index) => this.gameState.defendingCards[index]);
            if (allDefended && (this.gameState.attackingCards || []).length > 0) {
                html += '<button onclick="window.gameManager.getCurrentGame().passTurn()" class="action-btn">–ü–∞—Å (–æ—Ç–±–æ–π)</button>';
            }
        }

        html += '<button onclick="window.gameManager.getCurrentGame().newRound()" class="action-btn">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>';
        html += '<button onclick="window.gameManager.closeCurrentGame()" class="back-btn">–ù–∞–∑–∞–¥ –∫ –º–µ–Ω—é</button>';
        html += '</div>';

        html += '</div>';

        console.log('DurakGame.render(): setting innerHTML, html length:', html.length);
        this.container.innerHTML = html;
        this.container.style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        console.log('DurakGame.render(): container displayed');
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
    showLoadingState() {
        if (this.container) {
            this.container.innerHTML = `
                <div class="game-loading">
                    <h3>üé¥ –î—É—Ä–∞–∫</h3>
                    <div class="loading-spinner"></div>
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä—ã...</p>
                    <p>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...</p>
                </div>
            `;
            this.container.style.display = 'block';
        }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞, –º–æ–∂–µ—Ç –ª–∏ –∏–≥—Ä–æ–∫ —Å—ã–≥—Ä–∞—Ç—å –∫–∞—Ä—Ç–æ–π
    canPlayCard(card, index) {
        if (!this.gameState) return false;
        
        const playerRole = this.getCurrentPlayerRole();
        const playerCards = this.isNetworkGame ? 
            (playerRole === 'player1' ? this.gameState.player1Hand : this.gameState.player2Hand) : 
            this.gameState.playerHand;

        if (this.gameState.gamePhase === 'attack' && this.gameState.currentAttacker === playerRole) {
            // –ò–≥—Ä–æ–∫ –∞—Ç–∞–∫—É–µ—Ç
            if ((this.gameState.attackingCards || []).length === 0) {
                return true; // –ü–µ—Ä–≤–∞—è –∞—Ç–∞–∫–∞ - –ª—é–±–æ–π –∫–∞—Ä—Ç–æ–π
            } else {
                return this.canAttackOrThrowCard(card);
            }
        } else if (this.gameState.gamePhase === 'defend' && this.gameState.currentAttacker !== playerRole) {
            // –ò–≥—Ä–æ–∫ –∑–∞—â–∏—â–∞–µ—Ç—Å—è
            const undefendedCards = (this.gameState.attackingCards || []).filter((_, i) => !(this.gameState.defendingCards || [])[i]);
            return undefendedCards.some(attackCard => this.canDefendCard(card, attackCard));
        } else if (this.gameState.gamePhase === 'defend' && this.gameState.currentAttacker === playerRole) {
            // –ò–≥—Ä–æ–∫ –∞—Ç–∞–∫–æ–≤–∞–ª, –º–æ–∂–µ—Ç –ø–æ–¥–∫–∏–Ω—É—Ç—å
            const allDefended = (this.gameState.attackingCards || []).every((_, i) => (this.gameState.defendingCards || [])[i]);
            if (allDefended) {
                return this.canAttackOrThrowCard(card);
            }
        } else if (this.gameState.gamePhase === 'attack' && this.gameState.currentAttacker !== playerRole) {
            // –ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –∞—Ç–∞–∫–æ–≤–∞–ª, –∏–≥—Ä–æ–∫ –º–æ–∂–µ—Ç –ø–æ–¥–∫–∏–Ω—É—Ç—å –µ—Å–ª–∏ –≤—Å–µ –æ—Ç–±–∏—Ç—ã
            const allDefended = (this.gameState.attackingCards || []).every((_, i) => (this.gameState.defendingCards || [])[i]);
            if (allDefended) {
                return this.canAttackOrThrowCard(card);
            }
        }

        return false;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞, –º–æ–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É –¥–ª—è –∞—Ç–∞–∫–∏/–ø–æ–¥–∫–∏–¥—ã–≤–∞–Ω–∏—è
    canAttackOrThrowCard(card) {
        if (this.gameState.attackingCards.length === 0) return true;

        const tableValues = [...this.gameState.attackingCards, ...this.gameState.defendingCards]
            .map(c => c.value);
        return tableValues.includes(card.value);
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞, –º–æ–∂–Ω–æ –ª–∏ –∑–∞—â–∏—Ç–∏—Ç—å—Å—è –∫–∞—Ä—Ç–æ–π
    canDefendCard(defendCard, attackCard) {
        // –ú–æ–∂–Ω–æ –±–∏—Ç—å –∫–∞—Ä—Ç–æ–π —Ç–æ–π –∂–µ –º–∞—Å—Ç–∏, –Ω–æ –±–æ–ª—å—à–µ–≥–æ –¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–∞
        if (defendCard.suit === attackCard.suit && defendCard.power > attackCard.power) {
            return true;
        }

        // –ú–æ–∂–Ω–æ –±–∏—Ç—å –∫–æ–∑—ã—Ä–µ–º, –µ—Å–ª–∏ –∞—Ç–∞–∫—É—é—â–∞—è –∫–∞—Ä—Ç–∞ –Ω–µ –∫–æ–∑—ã—Ä—å
        if (defendCard.suit === this.gameState.trumpSuit && attackCard.suit !== this.gameState.trumpSuit) {
            return true;
        }

        // –ö–æ–∑—ã—Ä—å –º–æ–∂–Ω–æ –±–∏—Ç—å —Ç–æ–ª—å–∫–æ –±–æ–ª–µ–µ —Å—Ç–∞—Ä—à–∏–º –∫–æ–∑—ã—Ä–µ–º
        if (defendCard.suit === this.gameState.trumpSuit &&
            attackCard.suit === this.gameState.trumpSuit &&
            defendCard.power > attackCard.power) {
            return true;
        }

        return false;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
    handleCardClick(index) {
        if (!this.gameState) return;
        
        const playerRole = this.getCurrentPlayerRole();
        const playerCards = this.isNetworkGame ? 
            (playerRole === 'player1' ? this.gameState.player1Hand : this.gameState.player2Hand) : 
            this.gameState.playerHand;
        
        const card = playerCards[index];
        if (!card) return;

        if (this.gameState.gamePhase === 'attack' && this.gameState.currentAttacker === playerRole) {
            this.playerAttack(card, index);
        } else if (this.gameState.gamePhase === 'defend' && this.gameState.currentAttacker !== playerRole) {
            this.playerDefend(card, index);
        } else if (this.gameState.gamePhase === 'defend' && this.gameState.currentAttacker === playerRole) {
            this.playerThrow(card, index);
        } else if (this.gameState.gamePhase === 'attack' && this.gameState.currentAttacker !== playerRole) {
            this.playerThrow(card, index);
        }
    }

    // –ê—Ç–∞–∫–∞ –∏–≥—Ä–æ–∫–∞
    playerAttack(card, index) {
        if (this.gameState.attackingCards.length === 0) {
            // –ü–µ—Ä–≤–∞—è –∞—Ç–∞–∫–∞
            this.makeAttack(card, index);
        } else if (this.canAttackOrThrowCard(card)) {
            // –ü–æ–¥–∫–∏–¥—ã–≤–∞–Ω–∏–µ
            this.makeThrow(card, index);
        } else {
            this.showNotification('–ù–µ–ª—å–∑—è –ø–æ–¥–∫–∏–Ω—É—Ç—å —ç—Ç—É –∫–∞—Ä—Ç—É!', 'warning');
        }
    }

    // –ó–∞—â–∏—Ç–∞ –∏–≥—Ä–æ–∫–∞
    playerDefend(card, index) {
        const undefendedCards = this.gameState.attackingCards.filter((_, i) => !this.gameState.defendingCards[i]);

        if (undefendedCards.length === 0) {
            this.showNotification('–í—Å–µ –∫–∞—Ä—Ç—ã —É–∂–µ –æ—Ç–±–∏—Ç—ã!', 'warning');
            return;
        }

        const attackCard = undefendedCards[0];
        if (this.canDefendCard(card, attackCard)) {
            this.makeDefense(card, index);
        } else {
            this.showNotification('–≠—Ç–æ–π –∫–∞—Ä—Ç–æ–π –Ω–µ–ª—å–∑—è –æ—Ç–±–∏—Ç—å—Å—è!', 'warning');
        }
    }

    // –ü–æ–¥–∫–∏–¥—ã–≤–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
    playerThrow(card, index) {
        const allDefended = this.gameState.attackingCards.every((_, i) => this.gameState.defendingCards[i]);

        if (!allDefended) {
            this.showNotification('–°–Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ –æ—Ç–±–∏—Ç—å –≤—Å–µ –∞—Ç–∞–∫—É—é—â–∏–µ –∫–∞—Ä—Ç—ã!', 'warning');
            return;
        }

        if (this.canAttackOrThrowCard(card)) {
            this.makeThrow(card, index);
        } else {
            this.showNotification('–ù–µ–ª—å–∑—è –ø–æ–¥–∫–∏–Ω—É—Ç—å —ç—Ç—É –∫–∞—Ä—Ç—É!', 'warning');
        }
    }

    // –°–æ–≤–µ—Ä—à–µ–Ω–∏–µ –∞—Ç–∞–∫–∏
    makeAttack(card, index) {
        if (this.isNetworkGame) {
            this.sendMove({
                action: 'play',
                card: card,
                playerId: this.socket.id,
                cardIndex: index
            });
        }

        this.gameState.attackingCards.push(card);
        this.gameState.playerHand.splice(index, 1);
        this.gameState.gamePhase = 'defend';

        this.showNotification(`–í—ã —Å—ã–≥—Ä–∞–ª–∏ ${card.value}${card.suit}`, 'info');
        this.render();

        // –ë–æ—Ç –∑–∞—â–∏—â–∞–µ—Ç—Å—è
        if (this.currentOpponent?.type === 'bot') {
            setTimeout(() => this.makeBotDefense(), 1000);
        }
    }

    // –°–æ–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞—â–∏—Ç—ã
    makeDefense(card, index) {
        if (this.isNetworkGame) {
            this.sendMove({
                action: 'defend',
                card: card,
                playerId: this.socket.id,
                cardIndex: index
            });
        }

        const undefendedIndex = this.gameState.attackingCards.findIndex((_, i) => !this.gameState.defendingCards[i]);
        this.gameState.defendingCards[undefendedIndex] = card;
        this.gameState.playerHand.splice(index, 1);

        this.showNotification(`–í—ã –æ—Ç–±–∏–ª–∏—Å—å ${card.value}${card.suit}`, 'success');
        this.render();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ –∫–∞—Ä—Ç—ã –æ—Ç–±–∏—Ç—ã
        const allDefended = this.gameState.attackingCards.every((_, i) => this.gameState.defendingCards[i]);

        if (allDefended) {
            // –ë–æ—Ç –º–æ–∂–µ—Ç –ø–æ–¥–∫–∏–Ω—É—Ç—å
            if (this.currentOpponent?.type === 'bot') {
                setTimeout(() => this.makeBotThrow(), 1000);
            }
        } else {
            // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∑–∞—â–∏—Ç—É
            if (this.currentOpponent?.type === 'bot') {
                setTimeout(() => this.makeBotDefense(), 1000);
            }
        }
    }

    // –°–æ–≤–µ—Ä—à–µ–Ω–∏–µ –ø–æ–¥–∫–∏–¥—ã–≤–∞–Ω–∏—è
    makeThrow(card, index) {
        if (this.isNetworkGame) {
            this.sendMove({
                action: 'play',
                card: card,
                playerId: this.socket.id,
                cardIndex: index
            });
        }

        this.gameState.attackingCards.push(card);
        this.gameState.playerHand.splice(index, 1);
        this.gameState.gamePhase = 'defend';

        this.showNotification(`–í—ã –ø–æ–¥–∫–∏–Ω—É–ª–∏ ${card.value}${card.suit}`, 'info');
        this.render();

        // –ë–æ—Ç –∑–∞—â–∏—â–∞–µ—Ç—Å—è –æ—Ç –ø–æ–¥–∫–∏–Ω—É—Ç–æ–π –∫–∞—Ä—Ç—ã
        if (this.currentOpponent?.type === 'bot') {
            setTimeout(() => this.makeBotDefense(), 1000);
        }
    }

    // –ò–≥—Ä–æ–∫ –±–µ—Ä–µ—Ç –∫–∞—Ä—Ç—ã
    takeCards() {
        if (this.isNetworkGame) {
            this.sendMove({
                action: 'take',
                playerId: this.socket.id
            });
        }

        // –ò–≥—Ä–æ–∫ –±–µ—Ä–µ—Ç –≤—Å–µ –∫–∞—Ä—Ç—ã —Å–æ —Å—Ç–æ–ª–∞
        this.gameState.playerHand.push(...this.gameState.attackingCards);
        this.gameState.playerHand.push(...this.gameState.defendingCards);
        this.gameState.attackingCards = [];
        this.gameState.defendingCards = [];
        this.gameState.gamePhase = 'attack';
        this.gameState.currentAttacker = 'opponent'; // –¢–µ–ø–µ—Ä—å –∞—Ç–∞–∫—É–µ—Ç –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫

        this.refillHands();
        this.showNotification('–í—ã –≤–∑—è–ª–∏ –∫–∞—Ä—Ç—ã —Å–æ —Å—Ç–æ–ª–∞', 'warning');
        this.render();

        // –ë–æ—Ç –∞—Ç–∞–∫—É–µ—Ç
        if (this.currentOpponent?.type === 'bot') {
            setTimeout(() => this.makeBotAttack(), 1000);
        }
    }

    // –ü–∞—Å (–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞—É–Ω–¥–∞)
    passTurn() {
        if (this.isNetworkGame) {
            this.sendMove({
                action: 'pass',
                playerId: this.socket.id
            });
        }

        this.finishRound();
    }

    // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞—É–Ω–¥–∞
    finishRound() {
        // –£–±–∏—Ä–∞–µ–º –∫–∞—Ä—Ç—ã —Å–æ —Å—Ç–æ–ª–∞
        this.gameState.attackingCards = [];
        this.gameState.defendingCards = [];

        // –ú–µ–Ω—è–µ–º –∞—Ç–∞–∫—É—é—â–µ–≥–æ
        this.gameState.currentAttacker = this.gameState.currentAttacker === 'player' ? 'opponent' : 'player';
        this.gameState.gamePhase = 'attack';

        this.refillHands();
        this.showNotification('–†–∞—É–Ω–¥ –∑–∞–≤–µ—Ä—à–µ–Ω (–æ—Ç–±–æ–π)', 'info');
        this.render();

        // –ï—Å–ª–∏ —Ç–µ–ø–µ—Ä—å –∞—Ç–∞–∫—É–µ—Ç –±–æ—Ç, –¥–µ–ª–∞–µ–º –µ–≥–æ —Ö–æ–¥
        if (this.gameState.currentAttacker === 'opponent' && this.currentOpponent?.type === 'bot') {
            setTimeout(() => this.makeBotAttack(), 1000);
        }
    }

    // –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä—É–∫
    refillHands() {
        // –ü–æ–ø–æ–ª–Ω—è–µ–º —Ä—É–∫–∏ –¥–æ 6 –∫–∞—Ä—Ç
        while (this.gameState.playerHand.length < this.maxHandSize && this.deck.length > 0) {
            this.gameState.playerHand.push(this.deck.pop());
        }
        while (this.gameState.opponentHand.length < this.maxHandSize && this.deck.length > 0) {
            this.gameState.opponentHand.push(this.deck.pop());
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏–µ –∏–≥—Ä—ã
        this.checkGameEnd();
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏–≥—Ä—ã
    checkGameEnd() {
        const playerHasCards = this.gameState.playerHand.length > 0;
        const opponentHasCards = this.gameState.opponentHand.length > 0;
        const deckHasCards = this.deck.length > 0;

        if (!deckHasCards) {
            if (!playerHasCards && opponentHasCards) {
                this.gameState.winner = 'player';
                this.endGame('player');
            } else if (!opponentHasCards && playerHasCards) {
                this.gameState.winner = 'opponent';
                this.endGame('opponent');
            } else if (!playerHasCards && !opponentHasCards) {
                this.gameState.winner = 'draw';
                this.endGame('draw');
            }
        }
    }

    // –ê—Ç–∞–∫–∞ –±–æ—Ç–∞
    makeBotAttack() {
        if (this.gameState.currentAttacker !== 'opponent' || this.currentOpponent?.type !== 'bot') return;

        const bestCard = window.durakAnalyzer.getBestAttackCard();
        if (bestCard) {
            const cardIndex = this.gameState.opponentHand.indexOf(bestCard);
            if (cardIndex !== -1) {
                this.gameState.attackingCards.push(bestCard);
                this.gameState.opponentHand.splice(cardIndex, 1);
                this.gameState.gamePhase = 'defend';

                this.showNotification(`–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –∞—Ç–∞–∫–æ–≤–∞–ª ${bestCard.value}${bestCard.suit}`, 'info');
                this.render();
            }
        }
    }

    // –ó–∞—â–∏—Ç–∞ –±–æ—Ç–∞
    makeBotDefense() {
        if (this.currentOpponent?.type !== 'bot') return;

        const undefendedCards = this.gameState.attackingCards.filter((_, i) => !this.gameState.defendingCards[i]);

        if (undefendedCards.length === 0) {
            // –í—Å–µ –∫–∞—Ä—Ç—ã –æ—Ç–±–∏—Ç—ã, –±–æ—Ç –º–æ–∂–µ—Ç –ø–æ–¥–∫–∏–Ω—É—Ç—å
            setTimeout(() => this.makeBotThrow(), 1000);
            return;
        }

        const attackCard = undefendedCards[0];
        const defenseCard = window.durakAnalyzer.getBestDefenseCard(attackCard);

        if (defenseCard && window.durakAnalyzer.canDefendCard(defenseCard, attackCard)) {
            const cardIndex = this.gameState.opponentHand.indexOf(defenseCard);
            if (cardIndex !== -1) {
                const undefendedIndex = this.gameState.attackingCards.findIndex((_, i) => !this.gameState.defendingCards[i]);
                this.gameState.defendingCards[undefendedIndex] = defenseCard;
                this.gameState.opponentHand.splice(cardIndex, 1);

                this.showNotification(`–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –æ—Ç–±–∏–ª—Å—è ${defenseCard.value}${defenseCard.suit}`, 'info');
                this.render();

                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∑–∞—â–∏—Ç—É –∏–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø–æ–¥–∫–∏–¥—ã–≤–∞–Ω–∏—é
                const allDefended = this.gameState.attackingCards.every((_, i) => this.gameState.defendingCards[i]);
                if (allDefended) {
                    setTimeout(() => this.makeBotThrow(), 1000);
                } else {
                    setTimeout(() => this.makeBotDefense(), 1000);
                }
            }
        } else {
            // –ë–æ—Ç –±–µ—Ä–µ—Ç –∫–∞—Ä—Ç—ã
            this.botTakeCards();
        }
    }

    // –ü–æ–¥–∫–∏–¥—ã–≤–∞–Ω–∏–µ –±–æ—Ç–∞
    makeBotThrow() {
        if (this.gameState.currentAttacker === 'player' || this.currentOpponent?.type !== 'bot') return;

        const throwableCards = window.durakAnalyzer.getThrowableCards();

        if (throwableCards.length > 0) {
            const playerHandSize = this.gameState.playerHand.length;
            const throwProbability = playerHandSize <= 3 ? 0.9 : playerHandSize <= 5 ? 0.7 : 0.4;

            if (Math.random() < throwProbability) {
                const cardToThrow = throwableCards.reduce((weakest, card) =>
                    card.power < weakest.power ? card : weakest
                );

                const cardIndex = this.gameState.opponentHand.indexOf(cardToThrow);
                if (cardIndex !== -1) {
                    this.gameState.attackingCards.push(cardToThrow);
                    this.gameState.opponentHand.splice(cardIndex, 1);
                    this.gameState.gamePhase = 'defend';

                    this.showNotification(`–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –ø–æ–¥–∫–∏–Ω—É–ª ${cardToThrow.value}${cardToThrow.suit}`, 'info');
                    this.render();
                    return;
                }
            }
        }

        // –ë–æ—Ç –Ω–µ –ø–æ–¥–∫–∏–¥—ã–≤–∞–µ—Ç
        this.showNotification('–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞—É–Ω–¥ (–æ—Ç–±–æ–π)', 'info');
        this.finishRound();
    }

    // –ë–æ—Ç –±–µ—Ä–µ—Ç –∫–∞—Ä—Ç—ã
    botTakeCards() {
        this.gameState.opponentHand.push(...this.gameState.attackingCards);
        this.gameState.opponentHand.push(...this.gameState.defendingCards);
        this.gameState.attackingCards = [];
        this.gameState.defendingCards = [];
        this.gameState.gamePhase = 'attack';
        this.gameState.currentAttacker = 'player'; // –¢–µ–ø–µ—Ä—å –∞—Ç–∞–∫—É–µ—Ç –∏–≥—Ä–æ–∫

        this.refillHands();
        this.showNotification('–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –≤–∑—è–ª –∫–∞—Ä—Ç—ã —Å–æ —Å—Ç–æ–ª–∞', 'warning');
        this.render();
    }

    // –ù–æ–≤–∞—è –∏–≥—Ä–∞
    newRound() {
        this.gameState = {
            gameMode: 'durak',
            deck: [],
            playerHand: [],
            opponentHand: [],
            attackingCards: [],
            defendingCards: [],
            trumpSuit: null,
            currentAttacker: 'player',
            gamePhase: 'attack',
            winner: null
        };

        this.createDeck();
        this.shuffleDeck();
        this.setTrumpSuit();
        this.dealInitialCards();
        this.determineFirstPlayer();

        this.showNotification('üé¥ –ù–∞—á–∞—Ç–∞ –Ω–æ–≤–∞—è –∏–≥—Ä–∞ –≤ –¥—É—Ä–∞–∫!', 'info');
        this.render();
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö —Ö–æ–¥–æ–≤
    handleNetworkMove(move) {
        const { action, card, playerId, cardIndex } = move;
        const isCurrentPlayer = playerId === this.socket?.id;

        if (action === 'play' && card) {
            if (isCurrentPlayer) {
                const index = this.gameState.playerHand.findIndex(c =>
                    c.suit === card.suit && c.value === card.value
                );
                if (index !== -1) {
                    this.gameState.attackingCards.push(card);
                    this.gameState.playerHand.splice(index, 1);
                }
            } else {
                const index = this.gameState.opponentHand.findIndex(c =>
                    c.suit === card.suit && c.value === card.value
                );
                if (index !== -1) {
                    this.gameState.attackingCards.push(card);
                    this.gameState.opponentHand.splice(index, 1);
                }
            }
            this.gameState.gamePhase = 'defend';
            this.showNotification(`${isCurrentPlayer ? '–í—ã' : '–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫'} —Å—ã–≥—Ä–∞–ª–∏ ${card.value}${card.suit}`, 'info');

        } else if (action === 'defend' && card) {
            if (isCurrentPlayer) {
                const index = this.gameState.playerHand.findIndex(c =>
                    c.suit === card.suit && c.value === card.value
                );
                if (index !== -1) {
                    const undefendedIndex = this.gameState.attackingCards.findIndex((_, i) => !this.gameState.defendingCards[i]);
                    this.gameState.defendingCards[undefendedIndex] = card;
                    this.gameState.playerHand.splice(index, 1);
                }
            } else {
                const index = this.gameState.opponentHand.findIndex(c =>
                    c.suit === card.suit && c.value === card.value
                );
                if (index !== -1) {
                    const undefendedIndex = this.gameState.attackingCards.findIndex((_, i) => !this.gameState.defendingCards[i]);
                    this.gameState.defendingCards[undefendedIndex] = card;
                    this.gameState.opponentHand.splice(index, 1);
                }
            }
            this.showNotification(`${isCurrentPlayer ? '–í—ã' : '–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫'} –æ—Ç–±–∏–ª–∏—Å—å ${card.value}${card.suit}`, 'success');

        } else if (action === 'take') {
            if (isCurrentPlayer) {
                this.gameState.playerHand.push(...this.gameState.attackingCards);
                this.gameState.playerHand.push(...this.gameState.defendingCards);
                this.gameState.currentAttacker = 'opponent';
            } else {
                this.gameState.opponentHand.push(...this.gameState.attackingCards);
                this.gameState.opponentHand.push(...this.gameState.defendingCards);
                this.gameState.currentAttacker = 'player';
            }
            this.gameState.attackingCards = [];
            this.gameState.defendingCards = [];
            this.gameState.gamePhase = 'attack';
            this.refillHands();
            this.showNotification(`${isCurrentPlayer ? '–í—ã' : '–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫'} –≤–∑—è–ª–∏ –∫–∞—Ä—Ç—ã —Å–æ —Å—Ç–æ–ª–∞`, 'warning');

        } else if (action === 'pass') {
            this.finishRound();
        }

        this.render();
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç –∫–ª–∞—Å—Å–∞ –¥–ª—è ES6 –º–æ–¥—É–ª–µ–π
export { DurakGame };

// –≠–∫—Å–ø–æ—Ä—Ç –∫–ª–∞—Å—Å–∞ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å
window.DurakGame = DurakGame;
